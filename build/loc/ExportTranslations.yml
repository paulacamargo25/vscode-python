# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

pr: none
trigger:
  branches:
    include:
      - main
schedules:
- cron: "0 0 * * *"
  displayName: Daily midnight build
  branches:
    include:
    - main

stages:
- stage: Localization
  pool:
    vmImage: windows-latest
  variables:
    skipComponentGovernanceDetection: true
    VSCODE_EXTENSIONS_LOC_DIR: $(Pipeline.Workspace)/vscode-extensions-loc
    EXTENSION_DIR: $(Build.SourcesDirectory)
    VSCODE_TRANSLATIONS_EXPORT_DIR: $(Pipeline.Workspace)/vscode-python-translations-export
  jobs:
  - job: Localization
    timeoutInMinutes: 180
    steps:

    # Clone extension Repository and run translations-export to get xlf file
    - script: git clone https://github.com/microsoft/vscode-extensions-loc/ ${VSCODE_EXTENSIONS_LOC_DIR}
      displayName: Clone Microsoft/vscode-extensions-loc


    - task: NodeTool@0
      inputs:
        versionSpec: '14.18.2'
      displayName: Select Node version
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.7'
        addToPath: true
        architecture: 'x64'
      displayName: Select Python version
    - displayName: Install NPM dependencies
      script: 'cd $(EXTENSION_DIR) && npm ci'
    - script: npm run translations-export
      displayName: Run translations-export
    - publish: $(VSCODE_TRANSLATIONS_EXPORT_DIR)
      artifact: translations-export
      displayName: Publish translations-export

    - pwsh: |
        $Destination = "$(VSCODE_EXTENSIONS_LOC_DIR)/src/en"
        New-Item -ItemType Directory -Force "$(VSCODE_EXTENSIONS_LOC_DIR)/src/en"
        Move-Item "$(VSCODE_TRANSLATIONS_EXPORT_DIR)/*" $Destination
      displayName: Move vscode-python-translations-export to expected path

    - name: Create Pull Request on vscode-extensions-loc
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.REPO_PAT }}
          path: ${{ github.workspace }}/vscode-extensions-loc
          title: Update Localization xlf files
          body: Automated changes based on Microsoft/vscode-python@${{ github.sha }}
          branch: update-localization-files-microsoft-vscode-python-${{ github.sha }}
          commit-message: update localization xlf files Microsoft/vscode-python@${{ github.sha }}
          assignees: PaulaCamargo25
          delete-branch: true
